////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

// Обработчик события "ПередОткрытием" формы.
//
Процедура ПередОткрытием()
	
	ОрганизацияПоУмолчанию = УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(глЗначениеПеременной("глТекущийПользователь"), "ОсновнаяОрганизация");	
	
	Если НЕ Выбран() Тогда
		
		Период = Дата(1,1,1);
		
		Если ПараметрОбъектКопирования = Неопределено Тогда 
	
			Если Организация.Пустая() Тогда
				Организация = ОрганизацияПоУмолчанию;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры // ПередОткрытием()

// Обработчик события "ПередЗаписью" формы.
//
Процедура ПередЗаписью(Отказ)
	
	Если Период = Дата(1,1,1) Тогда
		ОбщегоНазначения.СообщитьОбОшибке("Не указана дата снятия с учета!", Отказ);
	КонецЕсли;
	
	Если Организация.Пустая() Тогда
		ОбщегоНазначения.СообщитьОбОшибке("Не указана организация!", Отказ);
	КонецЕсли;
	
	Если ОсновноеСредство.Пустая() Тогда
		ОбщегоНазначения.СообщитьОбОшибке("Не указано основное средство!", Отказ);
	КонецЕсли;
	
	Если НЕ Отказ И НЕ Выбран() Тогда
		
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("Период",           Период);
		Запрос.УстановитьПараметр("Организация",      Организация);
		Запрос.УстановитьПараметр("ОсновноеСредство", ОсновноеСредство);
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ПРЕДСТАВЛЕНИЕ(РегистрацияТранспортныхСредств.ВидЗаписи) КАК ВидЗаписи
		|ИЗ
		|	РегистрСведений.РегистрацияТранспортныхСредств КАК РегистрацияТранспортныхСредств
		|ГДЕ
		|	РегистрацияТранспортныхСредств.Период = &Период
		|	И РегистрацияТранспортныхСредств.Организация = &Организация
		|	И РегистрацияТранспортныхСредств.ОсновноеСредство = &ОсновноеСредство";
		Выборка = Запрос.Выполнить().Выбрать();
		
		Если Выборка.Количество() > 0 Тогда
			
			Выборка.Следующий();
			
			ОбщегоНазначения.СообщитьОбОшибке(Формат(Период, "ДФ=dd.MM.yyyy") + " по основному средству <" + СокрЛП(ОсновноеСредство) + "> 
			                                         |уже есть запись <" + Выборка.ВидЗаписи + "> в организации <" + СокрЛП(Организация) + ">!", Отказ);
			
		КонецЕсли;
		
		      		
	КонецЕсли;
	
	Если Отказ Тогда
		ОбщегоНазначения.СообщитьОбОшибке("Информация не записана.",,, СтатусСообщения.Обычное);
	КонецЕсли;
	
КонецПроцедуры // ПередЗаписью()

