Перем СписокРегионов;

Процедура ЗаполнитьСписокРегионов()
	
	СписокРегионов = Новый СписокЗначений;
	КлассификаторАдресов = РегистрыСведений.АдресныйКлассификатор.ПолучитьМакет("ТаблицаРегионов");
	
	Для Сч = 2 По КлассификаторАдресов.ВысотаТаблицы Цикл

		Код = Число(КлассификаторАдресов.Область(Сч, 1, Сч, 1).Текст);
		КодРегиона = Цел(Код / УправлениеКонтактнойИнформацией.МаскаРегиона());
		
		Наименование = СокрЛП(КлассификаторАдресов.Область(Сч, 2, Сч, 2).Текст);
		Сокращение   = СокрЛП(КлассификаторАдресов.Область(Сч, 3, Сч, 3).Текст);
		
		СписокРегионов.Добавить(КодРегиона,  Формат(КодРегиона, "ЧЦ=2; ЧВН=") + " " + Наименование + " " + Сокращение, Ложь);
		
	КонецЦикла;
	
	
КонецПроцедуры

Процедура ОтобразитьСписокРегионов()
	
	СписокМодифицировать.Очистить();
	СписокНеМодифицировать.Очистить();
	
	Для каждого ЭлементРегиона из СписокРегионов Цикл
		Если ЭлементРегиона.Пометка Тогда
			СтрокаРегиона = СписокМодифицировать.Добавить();
		Иначе
			СтрокаРегиона = СписокНеМодифицировать.Добавить();
		КонецЕсли;
		
		СтрокаРегиона.Значение = ЭлементРегиона.Значение;
		СтрокаРегиона.Регион = ЭлементРегиона.Представление;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура СписокМодифицироватьВыбор(Элемент, ЭлементСписка)
	
	Если ЭлементыФормы.СписокМодифицировать.ТекущиеДанные <> Неопределено Тогда
		Элемент = СписокРегионов.НайтиПоЗначению(ЭлементыФормы.СписокМодифицировать.ТекущиеДанные.Значение);
		Если Элемент <> Неопределено Тогда
			Элемент.Пометка = Ложь;
			ОтобразитьСписокРегионов();
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура СписокНеМодифицироватьВыбор(Элемент, ЭлементСписка)
	
	Если ЭлементыФормы.СписокНеМодифицировать.ТекущиеДанные <> Неопределено Тогда
		Элемент = СписокРегионов.НайтиПоЗначению(ЭлементыФормы.СписокНеМодифицировать.ТекущиеДанные.Значение);
		Если Элемент <> Неопределено Тогда
			Элемент.Пометка = Истина;
			ОтобразитьСписокРегионов();
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура КоманднаяПанель1ДобавитьВсе(Кнопка)
	
	СписокРегионов.ЗаполнитьПометки(Истина);
	ОтобразитьСписокРегионов();
	
КонецПроцедуры

Процедура КоманднаяПанель1Удалить(Кнопка)
	
	СписокРегионов.ЗаполнитьПометки(Ложь);
	ОтобразитьСписокРегионов();
	
КонецПроцедуры

Процедура КоманднаяПанель1Добавить(Кнопка)
	
	ВыделенныеСтроки = ЭлементыФормы.СписокНеМодифицировать.ВыделенныеСтроки;
	
	Для каждого ВыделеннаяСтрока из ВыделенныеСтроки Цикл
		Элемент = СписокРегионов.НайтиПоЗначению(ВыделеннаяСтрока.Значение);
		Если Элемент <> Неопределено Тогда
			Элемент.Пометка = Истина;
		КонецЕсли;
	КонецЦикла;
	
	Если ВыделенныеСтроки.Количество() > 0 Тогда
		ОтобразитьСписокРегионов();
	КонецЕсли;
	
КонецПроцедуры

Процедура КоманднаяПанель1Удалить1(Кнопка)
	
	
	ВыделенныеСтроки = ЭлементыФормы.СписокМодифицировать.ВыделенныеСтроки;
	
	Для каждого ВыделеннаяСтрока из ВыделенныеСтроки Цикл
		Элемент = СписокРегионов.НайтиПоЗначению(ВыделеннаяСтрока.Значение);
		Если Элемент <> Неопределено Тогда
			Элемент.Пометка = Ложь;
		КонецЕсли;
	КонецЦикла;
	
	Если ВыделенныеСтроки.Количество() > 0 Тогда
		ОтобразитьСписокРегионов();
	КонецЕсли;
	
	
КонецПроцедуры

Процедура ОсновныеДействияФормыОчистить(Кнопка)
	
	Ответ = Вопрос("Вся адресная информация в классификаторе по выбранным регионам будет удалена!
					|Очистить адресный классификатор по выбранным регионам?", РежимДиалогаВопрос.ДаНет);
	
	Если Ответ = КодВозвратаДиалога.Да Тогда
		
		МенеджерЗаписи = РегистрыСведений.АдресныйКлассификатор.СоздатьМенеджерЗаписи();
		НаборЗаписей = РегистрыСведений.АдресныйКлассификатор.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.КодРегионаВКоде.Использование = Истина;
		
		Для каждого Элемент Из СписокРегионов Цикл
			Если Элемент.Пометка Тогда
				// очищаем классификатор по региону
				Состояние("Очищаем классификатор по региону " + Элемент.Представление + ".");
				НаборЗаписей.Отбор.КодРегионаВКоде.Значение = Элемент.Значение;
				
				АдресныеСведения = РегистрыСведений.АдресныйКлассификатор.СоздатьНаборЗаписей();
				АдресныеСведения.Отбор.КодРегионаВКоде.Использование = Истина;
				АдресныеСведения.Отбор.КодРегионаВКоде.Значение = Элемент.Значение;
				
				ТексЗапроса = "ВЫБРАТЬ
				              |	АдресныйКлассификатор.Код,
				              |	АдресныйКлассификатор.КодРегионаВКоде,
				              |	АдресныйКлассификатор.Наименование,
				              |	АдресныйКлассификатор.Сокращение,
				              |	АдресныйКлассификатор.Индекс,
				              |	АдресныйКлассификатор.ТипАдресногоЭлемента,
				              |	АдресныйКлассификатор.КодРайонаВКоде,
				              |	АдресныйКлассификатор.КодГородаВКоде,
				              |	АдресныйКлассификатор.КодНаселенногоПунктаВКоде,
				              |	АдресныйКлассификатор.КодУлицыВКоде
				              |ИЗ
				              |	РегистрСведений.АдресныйКлассификатор КАК АдресныйКлассификатор
				              |
				              |ГДЕ
				              |	АдресныйКлассификатор.КодРегионаВКоде = &КодРегионаВКоде И
				              |	АдресныйКлассификатор.ТипАдресногоЭлемента = 1";
				
				Запрос = Новый Запрос(ТексЗапроса);
				Запрос.УстановитьПараметр("КодРегионаВКоде", Элемент.Значение);
				
				ВыборкаСведений = Запрос.Выполнить().Выбрать();
				
				Пока ВыборкаСведений.Следующий() Цикл
					
					ЗаписьАдреса = АдресныеСведения.Добавить();
					
					ЗаписьАдреса.Код = ВыборкаСведений.Код;
					
					ЗаписьАдреса.Наименование              = ВыборкаСведений.Наименование;
					ЗаписьАдреса.Сокращение                = ВыборкаСведений.Сокращение;
					ЗаписьАдреса.Индекс                    = ВыборкаСведений.Индекс;
					ЗаписьАдреса.ТипАдресногоЭлемента      = ВыборкаСведений.ТипАдресногоЭлемента;
					
					ЗаписьАдреса.КодРегионаВКоде           = ВыборкаСведений.КодРегионаВКоде;
					ЗаписьАдреса.КодРайонаВКоде            = ВыборкаСведений.КодРайонаВКоде;
					ЗаписьАдреса.КодГородаВКоде            = ВыборкаСведений.КодГородаВКоде;
					ЗаписьАдреса.КодНаселенногоПунктаВКоде = ВыборкаСведений.КодНаселенногоПунктаВКоде;
					ЗаписьАдреса.КодУлицыВКоде             = ВыборкаСведений.КодУлицыВКоде;
					
				КонецЦикла;

				АдресныеСведения.Записать(Истина);
				Сообщить("Очищена адресная информация по региону " + Элемент.Представление + ".", СтатусСообщения.Важное);

			КонецЕсли;
		КонецЦикла;
		
		// очищаем классификатор от элементом с нулевым регионом
		Состояние("Проверяем на существование записей с регионом ""0"".");
		НаборЗаписей.Отбор.КодРегионаВКоде.Значение = 0;
		НаборЗаписей.Прочитать();
		
		МенеджерЗаписи.КодРегионаВКоде = НаборЗаписей.Отбор.КодРегионаВКоде.Значение;
		
		Если НаборЗаписей.Количество() > 0 Тогда
			Для каждого ЗаписьРегистра из НаборЗаписей Цикл
				МенеджерЗаписи.Код = ЗаписьРегистра.Код;
				МенеджерЗаписи.Прочитать();
				МенеджерЗаписи.Удалить();
			КонецЦикла;
			Сообщить("Дополнительно удалены некорректные записи, содержащие регион 0!", СтатусСообщения.Важное);
		КонецЕсли;
		
	КонецЕсли;
	
	Предупреждение("Очистка завершена!");
	
	Закрыть();
	
КонецПроцедуры

Процедура ПриОткрытии()
	
	ЗаполнитьСписокРегионов();
	ОтобразитьСписокРегионов();
	
КонецПроцедуры
