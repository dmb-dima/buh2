
////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)
	
	ЭлементыФормы.Программа.СписокВыбора = УправлениеДенежнымиСредствами.СписокСовместимыхПрограммКлиентовБанка();
	
	ПолучитьДанные(БанковскийСчет);
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ЭЛЕМЕНТОВ ФОРМЫ

Процедура БанковскийСчетПриИзменении(Элемент)
	
	ПолучитьДанные(Элемент.Значение);
	
КонецПроцедуры

Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	Если Не ЗначениеЗаполнено(Настр_БанковскийСчет) Тогда
		Предупреждение("Не выбран банковский счет!");
		Возврат;
	КонецЕсли;
	
	Если Настр_Программа = "" Тогда
		Предупреждение("Не выбрана программа Клиента банка");
		Возврат;
	КонецЕсли;
	
	Если Настр_Дос Тогда
		Настр_Кодировка = "DOS";
	Иначе
		Настр_Кодировка = "Windows";
	КонецЕсли;
		
	ПрограммаКБ.Организация = Организация;
	ПрограммаКБ.БанковскийСчет = Настр_БанковскийСчет;
	ПрограммаКБ.Программа = Настр_Программа;
	ПрограммаКБ.Кодировка = Настр_Кодировка;
	ПрограммаКБ.ФайлВыгрузки = Настр_ФайлВыгрузки;
	ПрограммаКБ.ФайлЗагрузки = Настр_ФайлЗагрузки;
	ПрограммаКБ.ВидыВыгружаемыхПлатДокументов = Новый ХранилищеЗначения(Настр_ТаблицаДокументов);
	
	ПрограммаКБ.Записать();
	
	БанковскийСчет = Настр_БанковскийСчет;
	ФайлВыгрузки = Настр_ФайлВыгрузки;
	ФайлЗагрузки = Настр_ФайлЗагрузки;
	Кодировка = Настр_Кодировка;
	Программа = Настр_Программа;
	
	Для каждого СтрокаДокумента из Настр_ТаблицаДокументов Цикл
		НайденнаяСтрока = ТаблицаДокументов.Найти(СтрокаДокумента.Документ,"Название");
		НайденнаяСтрока.Пометка = СтрокаДокумента.Пометка; 
	КонецЦикла;
	
	НастройкаЗаполнения.Загрузить(Настр_ТаблицаНастроекПриЗагрузке);
	ГруппаДляНовыхКонтрагентов = Настр_Группа;
	
	Закрыть(Истина);
	
КонецПроцедуры

Процедура ФайлЗагрузкиОткрытие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = ложь;
	ОткрытьФайлДляПросмотра(Элемент,Кодировка,"Файл загрузки");
		
КонецПроцедуры

Процедура ФайлЗагрузкиНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	ВыборФайлаДляЗагрузки(Элемент);

КонецПроцедуры

Процедура ФайлВыгрузкиОткрытие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = ложь;
	ОткрытьФайлДляПросмотра(Элемент,Кодировка,"Файл выгрузки");
		
КонецПроцедуры

Процедура ФайлВыгрузкиНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	ВыборФайлаДляВыгрузки(Элемент);

КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ

Процедура ПолучитьДанные(Счет)
	
	ПрограммаКБ = РегистрыСведений.НастройкиОбменаСКлиентомБанка.СоздатьМенеджерЗаписи();
	ПрограммаКБ.БанковскийСчет = Счет;
	ПрограммаКБ.Организация = Организация;
	ПрограммаКБ.Прочитать();
	   
	Настр_БанковскийСчет = Счет;
	Настр_ТаблицаНастроекПриЗагрузке = НастройкаЗаполнения.Выгрузить();
	Настр_Группа = ГруппаДляНовыхКонтрагентов;
	
	Если ПрограммаКБ.Выбран() Тогда
		Настр_Программа = ПрограммаКБ.Программа;
		Настр_Кодировка = ПрограммаКБ.Кодировка;
		Настр_ФайлВыгрузки = ПрограммаКБ.ФайлВыгрузки;
		Настр_ФайлЗагрузки = ПрограммаКБ.ФайлЗагрузки;
		Таб = ПрограммаКБ.ВидыВыгружаемыхПлатДокументов.Получить();
	Иначе
		Настр_ФайлВыгрузки = КаталогПрограммы() + "1c_to_kl.txt";
		Настр_ФайлЗагрузки = КаталогПрограммы() + "kl_to_1c.txt";
	КонецЕсли;
	
	Если Таб=неопределено ИЛИ Таб.Количество() = 0 Тогда
		Настр_ТаблицаДокументов.Очистить();
		Док=Настр_ТаблицаДокументов.Добавить();
		Док.Пометка=Истина;
		Док.Документ="Платежное поручение";
		Док=Настр_ТаблицаДокументов.Добавить();
		Док.Документ="Платежное требование";	
	Иначе
		Настр_ТаблицаДокументов = Таб.Скопировать();               
	КонецЕсли;
	
	Если Настр_Кодировка = "DOS" Тогда
		Настр_Дос = Истина;
	Иначе
		Настр_Дос = Ложь;
	КонецЕсли;
	
КонецПроцедуры

