Перем ДатаНач_ОткрытиеСчетов;
Перем ДатаКон_ОткрытиеСчетов;

Перем ДатаНач_ЗачислениеЗарплаты Экспорт;
Перем ДатаКон_ЗачислениеЗарплаты Экспорт;

Перем ДатаНач_Импорт;
Перем ДатаКон_Импорт;

Перем ЭкспортУжеОбновляли;
Перем ИмпортУжеОбновляли;

Перем ФорматФайла1;
Перем ФорматФайла3;

// СОБЫТИЯ ФОРМЫ
Процедура УстановитьЗаголовкиОрганизацийВФорме()
	
	ЭлементыФормы.ЗявкиНаОткрытиеСчетов.Колонки.Организация.ТекстШапки = ОбщегоНазначения.ПреобразоватьСтрокуИнтерфейса("Организация");
	ЭлементыФормы.ПлатежныеДокументыЗачислениеЗарплаты.Колонки.Организация.ТекстШапки = ОбщегоНазначения.ПреобразоватьСтрокуИнтерфейса("Организация");
КонецПроцедуры // УстановитьЗаголовкиОрганизацийВФорме()

Процедура ПриОткрытии()
	
	// Восстанавливаем параментры сеанса работы
	
	Значение = ВосстановитьЗначение("Обработка.ИмпортЭкспортОперацийПоЛицевымСчетамРаботников.Кодировка");
	Если ЗначениеЗаполнено(Значение) Тогда
		Кодировка = Значение;
	Иначе
		Кодировка = 2;
	КонецЕсли;
	
	Значение = ВосстановитьЗначение("Обработка.ИмпортЭкспортОперацийПоЛицевымСчетамРаботников.КаталогИмпорта");
	Если Значение <> Неопределено Тогда
		КаталогИмпорта = Значение;
	КонецЕсли;
	
	Значение = ВосстановитьЗначение("Обработка.ИмпортЭкспортОперацийПоЛицевымСчетамРаботников.КаталогЭкспорта");
	Если Значение <> Неопределено Тогда
		КаталогЭкспорта = Значение;
	КонецЕсли;
	
	Значение = ВосстановитьЗначение("Обработка.ИмпортЭкспортОперацийПоЛицевымСчетамРаботников.НомерСНачалаГода");
	Если Значение <> Неопределено Тогда
		НомерСНачалаГода = Значение;
	КонецЕсли;
	
	Значение = ВосстановитьЗначение("Обработка.ИмпортЭкспортОперацийПоЛицевымСчетамРаботников.ОтделениеБанка");
	Если Значение <> Неопределено Тогда
		ОтделениеБанка = Значение;
	КонецЕсли;
	
	Значение = ВосстановитьЗначение("Обработка.ИмпортЭкспортОперацийПоЛицевымСчетамРаботников.ФилиалОтделенияБанка");
	Если Значение <> Неопределено Тогда
		ФилиалОтделенияБанка = Значение;
	КонецЕсли;
	
	ДатаНач_ОткрытиеСчетов = НачалоМесяца(ТекущаяДата());
	ДатаКон_ОткрытиеСчетов = КонецМесяца(ТекущаяДата());
	
	Если ДатаНач_ЗачислениеЗарплаты = Неопределено Тогда
		ДатаНач_ЗачислениеЗарплаты = НачалоМесяца(ТекущаяДата());
	КонецЕсли;
	
	Если ДатаКон_ЗачислениеЗарплаты = Неопределено Тогда
		ДатаКон_ЗачислениеЗарплаты = КонецМесяца(ТекущаяДата());
	КонецЕсли;
	
	ДатаНач_Импорт = НачалоМесяца(ТекущаяДата());
	ДатаКон_Импорт = КонецМесяца(ТекущаяДата());
	
	ОбновитьЗаявкиНаОткрытиеСчетов();
	ОбновитьЗачисленияЗарплаты();
	ПрочитатьСоставФайлов();

	ЭкспортУжеОбновляли = Ложь;
	ИмпортУжеОбновляли = Ложь;

	ДатаФормированияФайлов = ТекущаяДата();
	УстановитьЗаголовкиОрганизацийВФорме();
	
	ЭлементыФормы.ФорматФайлаОбмена.СписокВыбора.Добавить(Перечисления.ФорматФайлаОбменаПоЗарплатномуПроекту.Версия1, "Версия 1.0");
	ЭлементыФормы.ФорматФайлаОбмена.СписокВыбора.Добавить(Перечисления.ФорматФайлаОбменаПоЗарплатномуПроекту.Версия3, "Версия 3.0");
	ЭлементыФормы.ФорматФайлаОбмена.Значение = Перечисления.ФорматФайлаОбменаПоЗарплатномуПроекту.Версия1;
	ЭлементыФормы.ФорматФайлаОбмена1.СписокВыбора.Добавить(Перечисления.ФорматФайлаОбменаПоЗарплатномуПроекту.Версия1, "Версия 1.0");
	ЭлементыФормы.ФорматФайлаОбмена1.СписокВыбора.Добавить(Перечисления.ФорматФайлаОбменаПоЗарплатномуПроекту.Версия3, "Версия 3.0");
	ЭлементыФормы.ФорматФайлаОбмена1.Значение = Перечисления.ФорматФайлаОбменаПоЗарплатномуПроекту.Версия1;
	
КонецПроцедуры

Процедура ПередЗакрытием(Отказ, СтандартнаяОбработка)
	
	СохранитьЗначение("Обработка.ИмпортЭкспортОперацийПоЛицевымСчетамРаботников.Кодировка",  Кодировка);
	СохранитьЗначение("Обработка.ИмпортЭкспортОперацийПоЛицевымСчетамРаботников.КаталогИмпорта",  КаталогИмпорта);
	СохранитьЗначение("Обработка.ИмпортЭкспортОперацийПоЛицевымСчетамРаботников.КаталогЭкспорта", КаталогЭкспорта);
	СохранитьЗначение("Обработка.ИмпортЭкспортОперацийПоЛицевымСчетамРаботников.НомерСНачалаГода", НомерСНачалаГода);
	СохранитьЗначение("Обработка.ИмпортЭкспортОперацийПоЛицевымСчетамРаботников.ОтделениеБанка", ОтделениеБанка);
	СохранитьЗначение("Обработка.ИмпортЭкспортОперацийПоЛицевымСчетамРаботников.ФилиалОтделенияБанка", ФилиалОтделенияБанка);
	
КонецПроцедуры

Процедура БанкПолучательПриИзменении(Элемент)
	УправлениеДенежнымиСредствами.УстановитьБанковскийСчет(СчетБанкаПолучателя, БанкПолучатель, Константы.ВалютаРегламентированногоУчета.Получить());
КонецПроцедуры

// ОТКРЫТИЕ СЧЕТОВ

Процедура КаталогЭкспортаНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ДиалогВыбораКаталогЭкспорта = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.ВыборКаталога);
	ДиалогВыбораКаталогЭкспорта.Заголовок = "Открытие каталога для передачи файлов с операциями в банк";
	ДиалогВыбораКаталогЭкспорта.ПроверятьСуществованиеФайла = Истина;
	ДиалогВыбораКаталогЭкспорта.Каталог = КаталогЭкспорта;
	
	Если Не ДиалогВыбораКаталогЭкспорта.Выбрать() Тогда
		Возврат;
	КонецЕсли;
	
	КаталогЭкспорта = ДиалогВыбораКаталогЭкспорта.Каталог;
	
КонецПроцедуры

Процедура КаталогЭкспортаОткрытие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ЗапуститьПриложение(КаталогЭкспорта);
	
КонецПроцедуры


Процедура ОбновитьЗаявкиНаОткрытиеСчетов()
	
	ЗапросОткрытиеСчетов = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	                                    |	ЗаявкаНаОткрытиеСчетов.Ссылка,
	                                    |	ЗаявкаНаОткрытиеСчетов.ПометкаУдаления,
	                                    |	ЗаявкаНаОткрытиеСчетов.Номер,
	                                    |	ЗаявкаНаОткрытиеСчетов.Дата,
	                                    |	ЗаявкаНаОткрытиеСчетов.Проведен,
	                                    |	ЗаявкаНаОткрытиеСчетов.Организация,
	                                    |	ЗаявкаНаОткрытиеСчетов.Ответственный,
	                                    |	ЗаявкаНаОткрытиеСчетов.БанковскийСчет.НомерСчета Как НомерСчета,
	                                    |	ЗаявкаНаОткрытиеСчетов.ТекстПодтверждения,
	                                    |	ЗаявкаНаОткрытиеСчетов.НомерДоговора,
	                                    |	ЗаявкаНаОткрытиеСчетов.ОтделениеБанка,
	                                    |	ЗаявкаНаОткрытиеСчетов.ФилиалОтделенияБанка,
	                                    |	ЗаявкаНаОткрытиеСчетов.Комментарий,
	                                    |	ЗаявкаНаОткрытиеСчетов.ВидВклада
	                                    |ИЗ
	                                    |	Документ.ЗаявкаНаОткрытиеСчетов КАК ЗаявкаНаОткрытиеСчетов
	                                    |ГДЕ
										|	НЕ ЗаявкаНаОткрытиеСчетов.ВводНачальныхСведений
										|	И НЕ ЗаявкаНаОткрытиеСчетов.ПометкаУдаления
	                                    |	И ЗаявкаНаОткрытиеСчетов.Дата >= &ДатаНач
	                                    |	И ЗаявкаНаОткрытиеСчетов.Дата <= &ДатаКон");

	ЗапросОткрытиеСчетов.УстановитьПараметр("ДатаНач", ДатаНач_ОткрытиеСчетов);
	ЗапросОткрытиеСчетов.УстановитьПараметр("ДатаКон", ДатаКон_ОткрытиеСчетов);
	
	Выборка = ЗапросОткрытиеСчетов.Выполнить().Выбрать();
	
	ЗявкиНаОткрытиеСчетов.Очистить();
	
	Пока Выборка.Следующий() Цикл
		
		НоваяЗаявка = ЗявкиНаОткрытиеСчетов.Добавить();
		
		НоваяЗаявка.Дата                 = Выборка.Дата;
		НоваяЗаявка.Номер                = Выборка.Номер;
		НоваяЗаявка.Организация          = Выборка.Организация ;
		НоваяЗаявка.РасчетныйСчет        = Выборка.НомерСчета;
		НоваяЗаявка.НомерДоговора        = Выборка.НомерДоговора;
		НоваяЗаявка.ВидВклада            = Выборка.ВидВклада;
		НоваяЗаявка.Документ             = Выборка.Ссылка;
		
	КонецЦикла;
	
	ЭлементыФормы.РамкаГруппыОткрытиеСчетов.Заголовок = "Заявки на отрытие счетов (" + Формат(ДатаНач_ОткрытиеСчетов, "ДФ=dd.MM.yyyy") + " - " + Формат(ДатаКон_ОткрытиеСчетов, "ДФ=dd.MM.yyyy") + ")";
	
КонецПроцедуры


Процедура КоманднаяПанельЗявкиНаОткрытиеСчетовОбновить(Кнопка)
	
	ОбновитьЗаявкиНаОткрытиеСчетов();
	
КонецПроцедуры

Процедура КоманднаяПанельЗявкиНаОткрытиеСчетовУстановитьИнтервал(Кнопка)
	
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.УстановитьПериод(ДатаНач_ОткрытиеСчетов, ДатаКон_ОткрытиеСчетов);
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	НастройкаПериода.Редактировать();
	ДатаНач_ОткрытиеСчетов = НастройкаПериода.ПолучитьДатуНачала();
	ДатаКон_ОткрытиеСчетов = НастройкаПериода.ПолучитьДатуОкончания();
	
	ОбновитьЗаявкиНаОткрытиеСчетов();
	
КонецПроцедуры

Процедура ЗявкиНаОткрытиеСчетовПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	ОформлениеСтроки.Ячейки.Выгрузить.ОтображатьТекст = Ложь;
	ОформлениеСтроки.Ячейки.Выгрузить.ОтображатьФлажок = Истина;
	
КонецПроцедуры

Процедура КоманднаяПанельЗявкиНаОткрытиеСчетовУстановитьФлажки(Кнопка)
	
	Для каждого СтрокаЗаявок из ЗявкиНаОткрытиеСчетов ЦИкл
		СтрокаЗаявок.Выгрузить = Истина;
	КонецЦикла;
	
КонецПроцедуры

Процедура КоманднаяПанельЗявкиНаОткрытиеСчетовСнятьФлажки(Кнопка)
	
	Для каждого СтрокаЗаявок из ЗявкиНаОткрытиеСчетов ЦИкл
		СтрокаЗаявок.Выгрузить = Ложь;
	КонецЦикла;
	
КонецПроцедуры

Процедура ЗявкиНаОткрытиеСчетовВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ДокументЗаявки = Документы.ЗаявкаНаОткрытиеСчетов.НайтиПоНомеру(ВыбраннаяСтрока.Номер, ВыбраннаяСтрока.Дата);
	ДокументЗаявки.ПолучитьОбъект().ПолучитьФорму().Открыть();
	
КонецПроцедуры

Процедура ЗявкиНаОткрытиеСчетовПередНачаломДобавления(Элемент, Отказ, Копирование)
	Отказ = Истина;
КонецПроцедуры

Процедура ЗявкиНаОткрытиеСчетовПередУдалением(Элемент, Отказ)
	Отказ = Истина;
КонецПроцедуры

Процедура КоманднаяПанельЗявкиНаОткрытиеСчетовВыгрузить(Кнопка)
	
	Для каждого СтрокаСЗаявкой из ЗявкиНаОткрытиеСчетов цикл
		
		Если НЕ СтрокаСЗаявкой.Выгрузить Тогда
			Продолжить;
		КонецЕсли;
		
		// обрабатываем последовательно каждую заявку.
		ОчиститьДанныеЭкспорта();
		Заявка = СтрокаСЗаявкой.Документ.ПолучитьОбъект();
		ОрганизацияВЗаявке = Заявка.Организация;
		БанкВЗаявке = Заявка.БанковскийСчет.Банк;
		Для каждого СтрокаЗаявки из Заявка.РаботникиОрганизации Цикл
			Работник = СтрокаЗаявки.ФизЛицо;
			
			Если ВыгружатьТолькоНеИсполненныеЗаявки Тогда
				Если ПолучитьЛицевойСчет(Работник, ОрганизацияВЗаявке, БанкВЗаявке) <> Неопределено Тогда
					Продолжить;
				КонецЕсли;
			КонецЕсли;
			
			ДобавитьОткрытиеСчета(Работник, Заявка.ВидВклада, СтрокаЗаявки);
			
		КонецЦикла;
		
		Если ОткрытиеСчетов.Количество() > 0 Тогда
			// есть данные для отправки
			ЗадатьПараметрыСеанса(ДатаФормированияФайлов, Заявка.НомерДоговора, ОрганизацияВЗаявке, Заявка.БанковскийСчет, ПолучитьИДДокумента(СтрокаСЗаявкой.Документ));
			Документ = СтрокаСЗаявкой.Документ;
			КаталогЭкспортаДанных = КаталогЭкспорта;
			НачалоЭкспорта = ТекущаяДата();
			
			Если ЭкспортироватьДанные(НомерСНачалаГода, ОтделениеБанка) Тогда
				МенеджерЗаписиПротокола = РегистрыСведений.ПротоколыОбменаСБанком.СоздатьМенеджерЗаписи();
				МенеджерЗаписиПротокола.Документ = СтрокаСЗаявкой.Документ;
				МенеджерЗаписиПротокола.Дата = НачалоЭкспорта;
				МенеджерЗаписиПротокола.Содержание = ТекстXML;
				МенеджерЗаписиПротокола.Записать();
				
			КонецЕсли;
			
			Пока НачалоЭкспорта = ТекущаяДата() Цикл
			КонецЦикла;
		КонецЕсли;
		
		
		Если НомерСНачалаГода < 999 Тогда
			НомерСНачалаГода = НомерСНачалаГода + 1;
			
		Иначе
			НомерСНачалаГода = 0;
			
		КонецЕсли;
		
	КонецЦикла;
КонецПроцедуры


// ЗАЧИСЛЕНИЕ ЗАРПЛАТЫ

Процедура ОбновитьЗачисленияЗарплаты()
	
	ЗапросОткрытиеСчетов = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	                                    |	ЗарплатаКВыплатеОрганизаций.Номер КАК Номер,
	                                    |	ЗарплатаКВыплатеОрганизаций.Ссылка КАК Ссылка,
	                                    |	ЗарплатаКВыплатеОрганизаций.Дата КАК Дата,
	                                    |	ЗарплатаКВыплатеОрганизаций.Организация КАК Организация,
	                                    |	ЗарплатаКВыплатеОрганизаций.Организация.ОсновнойБанковскийСчет.НомерСчета КАК НомерСчета
	                                    |ИЗ
	                                    |	Документ.ЗарплатаКВыплатеОрганизаций КАК ЗарплатаКВыплатеОрганизаций
	                                    |ГДЕ
	                                    |	ЗарплатаКВыплатеОрганизаций.Дата <= &ДатаКон
	                                    |	И ЗарплатаКВыплатеОрганизаций.Дата >= &ДатаНач
	                                    |	И (НЕ ЗарплатаКВыплатеОрганизаций.ПометкаУдаления)
	                                    |	И ЗарплатаКВыплатеОрганизаций.СпособВыплаты = &СпособВыплаты");

	ЗапросОткрытиеСчетов.УстановитьПараметр("ДатаНач", НачалоДня(ДатаНач_ЗачислениеЗарплаты));
	ЗапросОткрытиеСчетов.УстановитьПараметр("ДатаКон", КонецДня(ДатаКон_ЗачислениеЗарплаты));
	ЗапросОткрытиеСчетов.УстановитьПараметр("СпособВыплаты", Перечисления.СпособыВыплатыЗарплаты.ЧерезБанк);
	
	Выборка = ЗапросОткрытиеСчетов.Выполнить().Выбрать();
	
	ПлатежныеДокументыЗачислениеЗарплаты.Очистить();
	
	Пока Выборка.Следующий() Цикл
		
		НоваяПлатежка = ПлатежныеДокументыЗачислениеЗарплаты.Добавить();
		
		НоваяПлатежка.Дата          = Выборка.Дата;
		НоваяПлатежка.Номер         = Выборка.Номер;
		НоваяПлатежка.Документ      = Выборка.Ссылка;
		НоваяПлатежка.РасчетныйСчет = Выборка.НомерСчета;
		НоваяПлатежка.Организация   = Выборка.Организация;

	КонецЦикла;

	ЭлементыФормы.РамкаГруппыЗачислениеЗарплаты.Заголовок = "Платежные поручения на зачисление зарплаты (" + Формат(ДатаНач_ЗачислениеЗарплаты, "ДФ=dd.MM.yyyy") + " - " + Формат(ДатаКон_ЗачислениеЗарплаты, "ДФ=dd.MM.yyyy") + ")";
	
	ЭкспортУжеОбновляли = Истина;
	
КонецПроцедуры

Процедура КоманднаяПанельПлатежныеДокументыЗачислениеЗарплатыОбновить(Кнопка)
	
	ОбновитьЗачисленияЗарплаты();
	
КонецПроцедуры

Процедура ПлатежныеДокументыЗачислениеЗарплатыПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	ОформлениеСтроки.Ячейки.Выгрузить.ОтображатьТекст = Ложь;
	ОформлениеСтроки.Ячейки.Выгрузить.ОтображатьФлажок = Истина;
	
КонецПроцедуры

Процедура КоманднаяПанельПлатежныеДокументыЗачислениеЗарплатыУстановитьИнтервал(Кнопка)
	
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.УстановитьПериод(ДатаНач_ЗачислениеЗарплаты, ДатаКон_ЗачислениеЗарплаты);
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	НастройкаПериода.Редактировать();
	ДатаНач_ЗачислениеЗарплаты = НастройкаПериода.ПолучитьДатуНачала();
	ДатаКон_ЗачислениеЗарплаты = НастройкаПериода.ПолучитьДатуОкончания();
	
	ОбновитьЗачисленияЗарплаты();
	
КонецПроцедуры

Процедура КоманднаяПанельПлатежныеДокументыЗачислениеЗарплатыУстановитьФлажки(Кнопка)
	
	Для каждого СтрокаЗачислениеЗарплаты из ПлатежныеДокументыЗачислениеЗарплаты ЦИкл
		СтрокаЗачислениеЗарплаты.Выгрузить = Истина;
	КонецЦикла;
	
КонецПроцедуры

Процедура КоманднаяПанельПлатежныеДокументыЗачислениеЗарплатыСнятьФлажки(Кнопка)
	
	Для каждого СтрокаЗачислениеЗарплаты из ПлатежныеДокументыЗачислениеЗарплаты ЦИкл
		СтрокаЗачислениеЗарплаты.Выгрузить = Ложь;
	КонецЦикла;
	
КонецПроцедуры

Процедура КоманднаяПанельПлатежныеДокументыЗачислениеЗарплатыВыгрузить(Кнопка)
	Если ФорматФайлаОбмена = ФорматФайла1 Тогда
		Для каждого СтрокаСПлатежкой из ПлатежныеДокументыЗачислениеЗарплаты цикл
			Если НЕ СтрокаСПлатежкой.Выгрузить Тогда
				Продолжить;
			КонецЕсли;
			
			// обрабатываем последовательно каждую заявку.
			ОчиститьДанныеЭкспорта();
			Платежка = СтрокаСПлатежкой.Документ.ПолучитьОбъект();
			
			ОрганизацияВПлатежке = Платежка.Организация;
			СчетПеречисления = СчетБанкаПолучателя;
			БанкПеречисления = СчетБанкаПолучателя.Банк;
			
			Ведомость = Платежка;
			
			Для каждого СтрокаВедомости из Ведомость.Зарплата Цикл
				Работник = СтрокаВедомости.ФизЛицо;
				Сумма = СтрокаВедомости.Сумма + СтрокаВедомости.КомпенсацияЗаЗадержкуЗарплаты;
				ЛицевойСчет = ПолучитьЛицевойСчет(Работник, ОрганизацияВПлатежке, БанкПеречисления);
				Если ЛицевойСчет = Неопределено Тогда
					Сообщить("Перечисление (" + Сумма + " руб." + ")" + Работник + " не может быть произведено: отсутствует лицевой счет!", СтатусСообщения.Важное);
					Продолжить;
				КонецЕсли;
				ДобавитьЗачислениеЗарплаты(Работник, Сумма, ЛицевойСчет);
			КонецЦикла;
			
			Если ЗачислениеЗарплаты.Количество() > 0 Тогда
				// есть данные для отправки
				ЗадатьПараметрыСеанса(ДатаФормированияФайлов, НомерДоговораЗачисленияЗарплаты, ОрганизацияВПлатежке, СчетПеречисления, ПолучитьИДДокумента(СтрокаСПлатежкой.Документ));
				КаталогЭкспортаДанных = КаталогЭкспорта;
				НачалоЭкспорта = ТекущаяДата();
				
				Если ЭкспортироватьДанные(НомерСНачалаГода, ОтделениеБанка) Тогда
					МенеджерЗаписиПротокола = РегистрыСведений.ПротоколыОбменаСБанком.СоздатьМенеджерЗаписи();
					МенеджерЗаписиПротокола.Документ = СтрокаСПлатежкой.Документ;
					МенеджерЗаписиПротокола.Дата = НачалоЭкспорта;
					МенеджерЗаписиПротокола.Содержание = ТекстXML;
					МенеджерЗаписиПротокола.Записать();
					
				КонецЕсли;
				
			КонецЕсли;
			
			
			Если НомерСНачалаГода < 999 Тогда
				НомерСНачалаГода = НомерСНачалаГода + 1;
				
			Иначе
				НомерСНачалаГода = 0;
				
			КонецЕсли;
			
		КонецЦикла;
	ИначеЕсли ФорматФайлаОбмена = ФорматФайла3 Тогда
		Для каждого СтрокаСПлатежкой из ПлатежныеДокументыЗачислениеЗарплаты цикл
			Если НЕ СтрокаСПлатежкой.Выгрузить Тогда
				Продолжить;
			КонецЕсли;
			
			// обрабатываем последовательно каждую заявку.
			ОчиститьДанныеЭкспорта();
			Платежка = СтрокаСПлатежкой.Документ.ПолучитьОбъект();
			
			ОрганизацияВПлатежке = Платежка.Организация;
			СчетПеречисления = СчетБанкаПолучателя;
			БанкПеречисления = СчетБанкаПолучателя.Банк;
			
			Ведомость = Платежка;
				
			Для каждого СтрокаВедомости из Ведомость.Зарплата Цикл
				Работник = СтрокаВедомости.ФизЛицо;
				Сумма = СтрокаВедомости.Сумма + СтрокаВедомости.КомпенсацияЗаЗадержкуЗарплаты;
				ЛицевойСчет = ПолучитьЛицевойСчет(Работник, ОрганизацияВПлатежке, БанкПеречисления);
				Если ЛицевойСчет = Неопределено Тогда
					Сообщить("Перечисление (" + Сумма + " руб." + ")" + Работник + " не может быть произведено: отсутствует лицевой счет!", СтатусСообщения.Важное);
					Продолжить;
				КонецЕсли;
				ДобавитьЗачислениеЗарплаты(Работник, Сумма, ЛицевойСчет);
			КонецЦикла;
						
			Если ЗачислениеЗарплаты.Количество() > 0 Тогда
				// есть данные для отправки
				ЗадатьПараметрыСеанса(ДатаФормированияФайлов, НомерДоговораЗачисленияЗарплаты, ОрганизацияВПлатежке, СчетПеречисления, ПолучитьИДДокумента(СтрокаСПлатежкой.Документ));
				КаталогЭкспортаДанных = КаталогЭкспорта;
				НачалоЭкспорта = ТекущаяДата();
				
				Если ЭкспортироватьДанные(НомерСНачалаГода, ОтделениеБанка) Тогда
					МенеджерЗаписиПротокола = РегистрыСведений.ПротоколыОбменаСБанком.СоздатьМенеджерЗаписи();
					МенеджерЗаписиПротокола.Документ = СтрокаСПлатежкой.Документ;
					МенеджерЗаписиПротокола.Дата = НачалоЭкспорта;
					МенеджерЗаписиПротокола.Содержание = ТекстXML;
					МенеджерЗаписиПротокола.Записать();
					
				КонецЕсли;
				
			КонецЕсли;
			
			
			Если НомерСНачалаГода < 999 Тогда
				НомерСНачалаГода = НомерСНачалаГода + 1;
				
			Иначе
				НомерСНачалаГода = 0;
				
			КонецЕсли;
			
		КонецЦикла;
	КонецЕсли;
КонецПроцедуры


// ИМПОРТ

Процедура КаталогИмпортаНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ДиалогВыбораКаталогаИмпорта = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.ВыборКаталога);
	ДиалогВыбораКаталогаИмпорта.Заголовок = "Открытие каталога с файлами ответов из банка";
	ДиалогВыбораКаталогаИмпорта.ПроверятьСуществованиеФайла = Истина;
	ДиалогВыбораКаталогаИмпорта.Каталог = КаталогИмпорта;
	
	Если Не ДиалогВыбораКаталогаИмпорта.Выбрать() Тогда
		Возврат;
	КонецЕсли;
	
	КаталогИмпорта = ДиалогВыбораКаталогаИмпорта.Каталог;
	
	ПрочитатьСоставФайлов();

КонецПроцедуры

Процедура КаталогИмпортаОткрытие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ЗапуститьПриложение(КаталогИмпорта);
	
КонецПроцедуры

Процедура ПрочитатьСоставФайлов()
	
	ФайлыДляИмпорта.Очистить();
	
	ФайлДанных = Новый Файл(КаталогИмпорта);
	
	Если ФайлДанных.Существует() Тогда
		КаталогИмпортаДанных = КаталогИмпорта;
		МассивФайловИмпорта = НайтиФайлы(КаталогИмпорта, "*.*");
		Для Каждого ФайлИмпорта из МассивФайловИмпорта Цикл
			
			Если ФайлИмпорта.ЭтоКаталог() Тогда
				Продолжить;
			КонецЕсли;
		
			ДатаИзменения = ФайлИмпорта.ПолучитьВремяИзменения();
			
			Если ДатаИзменения < ДатаНач_Импорт Тогда
				Продолжить;
			КонецЕсли;
			
			Если ДатаИзменения > ДатаКон_Импорт Тогда
				Продолжить;
			КонецЕсли;
			
			Если ФайлИмпорта.Размер() > 10000000 Тогда
				Продолжить;
			КонецЕсли;
			
			СтрокаСФайлом = ФайлыДляИмпорта.Добавить();
			СтрокаСФайлом.Файл = ФайлИмпорта.Имя;
			СтрокаСФайлом.Дата = ДатаИзменения;
			ФайлИмпорта = Неопределено;
			
			Попытка
				ТочкаВхода = ПолучитьДеревоИзФайла(СтрокаСФайлом.Файл, Ложь);
				
				Если ТочкаВхода <> Неопределено Тогда
					СчетаПК = ПолучитьСчетаПК(ТочкаВхода, СтрокаСФайлом.Файл, Ложь);
					СтрокаСФайлом.ДатаОперации = Дата(СчетаПК.ДатаФормирования);
				КонецЕсли;
				
			Исключение
			КонецПопытки;
			
		КонецЦикла;
		
	КонецЕсли;
	
	ЭлементыФормы.РамкаГруппыФайлыДляИмпорта.Заголовок = "Файлы для импорта  (" + Формат(ДатаНач_Импорт, "ДФ=dd.MM.yyyy") + " - " + Формат(ДатаКон_Импорт, "ДФ=dd.MM.yyyy") + ")";
	
	ИмпортУжеОбновляли = Истина;
	
КонецПроцедуры


Процедура КоманднаяПанельФайлыДляИмпортаОбновить(Кнопка)
	
	ПрочитатьСоставФайлов();
	
КонецПроцедуры

Процедура КоманднаяПанельФайлыДляИмпортаУстановитьИнтервал(Кнопка)
	
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.УстановитьПериод(ДатаНач_Импорт, ДатаКон_Импорт);
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	НастройкаПериода.Редактировать();
	ДатаНач_Импорт = НастройкаПериода.ПолучитьДатуНачала();
	ДатаКон_Импорт = НастройкаПериода.ПолучитьДатуОкончания();
	
	ПрочитатьСоставФайлов();
	
КонецПроцедуры

Процедура КоманднаяПанельФайлыДляИмпортаУстановитьФлажки(Кнопка)
	
	Для каждого СтрокаФайлыДляИмпорта из ФайлыДляИмпорта ЦИкл
		СтрокаФайлыДляИмпорта.Загрузить = Истина;
	КонецЦикла;
	
КонецПроцедуры

Процедура КоманднаяПанельФайлыДляИмпортаСнятьФлажки(Кнопка)
	
	Для каждого СтрокаФайлыДляИмпорта из ФайлыДляИмпорта ЦИкл
		СтрокаФайлыДляИмпорта.Загрузить = Ложь;
	КонецЦикла;
	
КонецПроцедуры

Процедура ФайлыДляИмпортаПередНачаломДобавления(Элемент, Отказ, Копирование)
	Отказ = Истина;
КонецПроцедуры

Процедура ФайлыДляИмпортаПередУдалением(Элемент, Отказ)
	Отказ = Истина;
КонецПроцедуры

// ОПЕРАЦИИ ПО СЧЕТАМ

Процедура КоманднаяПанельФайлыДляИмпортаЗагрузить(Кнопка)
	
	Для каждого СтрокаСФайлом из ФайлыДляИмпорта Цикл
		Если НЕ СтрокаСФайлом.Загрузить Тогда
			Продолжить;
		КонецЕсли;
		
		КаталогИмпортаДанных = КаталогИмпорта;
		ТочкаВхода = ПолучитьДеревоИзФайла(СтрокаСФайлом.Файл);
		Если ТочкаВхода = Неопределено Тогда
			ПроцедурыУправленияПерсоналом.СообщитьОбОшибкеОбработки("Импорт из файла " + СтрокаСФайлом.Файл, "Нарушена структура данных!");
			Продолжить;
		КонецЕсли;
		
		СчетаПК = ПолучитьСчетаПК(ТочкаВхода, СтрокаСФайлом.Файл);
		СтрокаГУИД = СчетаПК.ИдПервичногоДокумента;
		
		СтадияОбработки = "Анализ данных " + СтрокаСФайлом.Файл;
		
		ПервичныйДокумент = Документы.ЗаявкаНаОткрытиеСчетов.ПолучитьСсылку(Новый УникальныйИдентификатор(СтрокаГУИД));
		ЭлементыИмпорта = "РезультатОткрытияСчетов";
		
		Если НЕ ЗначениеЗаполнено(ПервичныйДокумент.Дата) Тогда
			
			ПервичныйДокумент = Документы.ЗарплатаКВыплатеОрганизаций.ПолучитьСсылку(Новый УникальныйИдентификатор(СтрокаГУИД));
			ЭлементыИмпорта = "РезультатЗачисленияЗарплаты";
			
			Если НЕ ЗначениеЗаполнено(ПервичныйДокумент.Дата) Тогда
				ПроцедурыУправленияПерсоналом.СообщитьОбОшибкеОбработки(СтадияОбработки, "Не найден первичный документ!");
				Продолжить;
			КонецЕсли;
			
		КонецЕсли;
		
		МенеджерЗаписиПротокола = РегистрыСведений.ПротоколыОбменаСБанком.СоздатьМенеджерЗаписи();
		МенеджерЗаписиПротокола.Документ = ПервичныйДокумент;
		МенеджерЗаписиПротокола.Дата = ТекущаяДата();
		МенеджерЗаписиПротокола.Содержание = ТекстXML;
		МенеджерЗаписиПротокола.Записать();
		
		Если ЭлементыИмпорта = "РезультатОткрытияСчетов" Тогда
			// записываем текст в первичный документ и проводим его
			ОбъектДокумента = ПервичныйДокумент.ПолучитьОбъект();
			Если ОбъектДокумента <> Неопределено Тогда
				ТекстПодтверждения = ОбъектДокумента.ТекстПодтверждения;
				Попытка
					ИсходноеДерево = ЗначениеИзСтрокиВнутр(ОбъектДокумента.ТекстПодтверждения);
				Исключение
					ИсходноеДерево = СоздатьДеревоЭкспорта();
				КонецПопытки;
				
				Если ТипЗнч(ИсходноеДерево) <> Тип("ДеревоЗначений") Тогда
					ИсходноеДерево = СоздатьДеревоЭкспорта();
				КонецЕсли;
				
				Для каждого ОперацияПодтверждения из СчетаПК.Содержимое.СТроки Цикл
					НоваяОперация = ИсходноеДерево.Строки.Добавить();
					СкопироватьСодержание(ОперацияПодтверждения, НоваяОперация);
				КонецЦикла;
				
				ОбъектДокумента.ТекстПодтверждения = ЗначениеВСтрокуВнутр(ИсходноеДерево);
				Попытка
					ОбъектДокумента.Записать(РежимЗаписиДокумента.Проведение);					
				Исключение
					Сообщить("Загрузка данных отменена!");
				КонецПопытки;
				
			Иначе
				ПроцедурыУправленияПерсоналом.СообщитьОбОшибкеОбработки(СтадияОбработки, "Не найден первичный документ!");
				
			КонецЕсли;
			
		Иначе
			// получаем массив операций и вводим на его основании ордер
			МассивОпераций = ПроцедурыУправленияПерсоналом.ПолучитьОперацииПоЛицевымСчетамРаботников(СчетаПК.Содержимое, ЭлементыИмпорта);
			Ордер = Документы.СписаниеСРасчетногоСчета.СоздатьДокумент();
			Ордер.ДокументОснование = ПервичныйДокумент;
			Ордер.Организация = ПервичныйДокумент.Организация;
			
			ТаблицаПередачи = Новый ТаблицаЗначений;
			ТаблицаПередачи.Колонки.Добавить("Ведомость");
			ТаблицаПередачи.Колонки.Добавить("ФизЛицо");
			ТаблицаПередачи.Колонки.Добавить("СуммаПлатежа");
			
			СписокВедомостей = Новый СписокЗначений();
			СоответствиеРаботников = Новый Соответствие;
			СписокВедомостей.Добавить(ПервичныйДокумент);
			
			ЗапросРаботников = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	ЗарплатаКВыплатеОрганизаций.Ссылка,
			|	ЗарплатаКВыплатеОрганизаций.Зарплата.(
			|		Физлицо
			|	)
			|ИЗ
			|	Документ.ЗарплатаКВыплатеОрганизаций КАК ЗарплатаКВыплатеОрганизаций
			|ГДЕ
			|	ЗарплатаКВыплатеОрганизаций.Ссылка В (&СписокВедомостей)");
			
			ЗапросРаботников.УстановитьПараметр("СписокВедомостей", СписокВедомостей);
			
			НоваяВыборкаВедомостей = ЗапросРаботников.Выполнить().Выбрать();
			
			Пока НоваяВыборкаВедомостей.Следующий() Цикл
				ВыборкаРаботников = НоваяВыборкаВедомостей.Зарплата.Выбрать();
				Пока ВыборкаРаботников.Следующий() Цикл
					СоответствиеРаботников.Вставить(ВыборкаРаботников.ФизЛицо, НоваяВыборкаВедомостей.Ссылка);
				КонецЦикла;
			КонецЦикла;
			
			СписокСотрудниковСНезачисленнойЗарплатой = "";	
			Для каждого ОперацияПодтверждения из МассивОпераций Цикл
				
				Если НРег(ОперацияПодтверждения.Результат) = "зачислено" Тогда
					СтрокаПередачи = ТаблицаПередачи.Добавить();
					СтрокаПередачи.ФизЛицо = ОперацияПодтверждения.Сотрудник;
					СтрокаПередачи.СуммаПлатежа = ОперацияПодтверждения.Сумма;
					СтрокаПередачи.Ведомость = СоответствиеРаботников[ОперацияПодтверждения.Сотрудник];
				Иначе
					СписокСотрудниковСНезачисленнойЗарплатой = СписокСотрудниковСНезачисленнойЗарплатой + Символы.ПС + " " + Строка(ОперацияПодтверждения.Сотрудник) + "  " + ОперацияПодтверждения.Результат;
				КонецЕсли;
				
			КонецЦикла;
			
			Ордер.Дата = ТекущаяДата();
			Ордер.СчетБанк = ПланыСчетов.Хозрасчетный.РасчетныеСчета;
			Ордер.ЗаполнитьПеречислениеЗППоОбменуСБанком(ТаблицаПередачи, ПервичныйДокумент);
			ЗаполнениеДокументов.ЗаполнитьШапкуДокумента(Ордер, глЗначениеПеременной("глТекущийПользователь"));
			Ордер.Записать();
			Если СписокСотрудниковСНезачисленнойЗарплатой <> "" Тогда
				ОбщегоНазначения.СообщитьОбОшибке("Следующим сотрудникам деньги не зачислены на счет в банке: " + СписокСотрудниковСНезачисленнойЗарплатой, Истина, Строка(Ордер));
			КонецЕсли;
			Если МенеджерЗаписиПротокола.Документ = Неопределено Тогда
				МенеджерЗаписиПротокола.Документ = Ордер.Ссылка;
				МенеджерЗаписиПротокола.Записать();
			КонецЕсли;
			Ордер.ПолучитьФорму().Открыть();
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ФайлыДляИмпортаВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	
	Если ВыбраннаяСтрока <> Неопределено Тогда
		ЗапуститьПриложение(КаталогИмпорта + "\" + ВыбраннаяСтрока.Файл);
	КонецЕсли;
	
КонецПроцедуры

Процедура КоманднаяПанельФайлыДляИмпортаЛицевыеСчетаСотрудников(Кнопка)
	
	РегистрыСведений.ЛицевыеСчетаРаботниковОрганизации.ПолучитьФормуСписка().Открыть();
	
КонецПроцедуры

Процедура ПлатежныеДокументыЗачислениеЗарплатыПередНачаломДобавления(Элемент, Отказ, Копирование)
	Отказ = Истина;
КонецПроцедуры

Процедура ПлатежныеДокументыЗачислениеЗарплатыПередУдалением(Элемент, Отказ)
	Отказ = Истина;
КонецПроцедуры

Процедура ПлатежныеДокументыЗачислениеЗарплатыВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	
	Если ВыбраннаяСтрока <> Неопределено Тогда
		ВыбраннаяСтрока.Документ.ПолучитьОбъект().ПолучитьФорму().Открыть();
	КонецЕсли;
	
КонецПроцедуры

Процедура КоманднаяПанельЗявкиНаОткрытиеСчетовПечать(Кнопка)
	
	Для каждого СтрокаСЗаявкой из ЗявкиНаОткрытиеСчетов Цикл
		Если СтрокаСЗаявкой.Выгрузить Тогда
			ТабДокумент = ПечатьЗаявки(СтрокаСЗаявкой.Документ);
			НапечататьДокумент(ТабДокумент, 1, Ложь, "Заявка на открытие счетов №" + СтрокаСЗаявкой.Номер);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура КоманднаяПанельПлатежныеДокументыЗачислениеЗарплатыПечать(Кнопка)
	
	Для каждого СтрокаСПеречислением из ПлатежныеДокументыЗачислениеЗарплаты Цикл
		Если СтрокаСПеречислением.Выгрузить Тогда
			ТабДокумент = ПечатьПеречисленияЗарплаты(СтрокаСПеречислением.Документ);
			НапечататьДокумент(ТабДокумент, 1, Ложь, "Ведомость перечисленных средств на лицевые счета №" + СтрокаСПеречислением.Номер);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры




ФорматФайла1 = Перечисления.ФорматФайлаОбменаПоЗарплатномуПроекту.Версия1;
ФорматФайла3 = Перечисления.ФорматФайлаОбменаПоЗарплатномуПроекту.Версия3;